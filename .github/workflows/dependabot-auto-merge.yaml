name: ðŸ¤– Dependabot Auto-Merge

# Responsibility: Auto-merge safe dependabot PRs
# - GitHub Actions: patch/minor updates
# - npm (root workspace): patch/minor updates for specific safe groups
# - Requires CI to pass first
# Note: test/ directory is managed in a separate repository

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  # Re-evaluate when check suites complete
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

# Concurrency control for sequential processing
concurrency:
  group: dependabot-auto-merge
  cancel-in-progress: false

jobs:
  auto-merge:
    name: ðŸ¤– Auto-Merge Dependabot
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Increased to accommodate check waiting time
    if: github.actor == 'dependabot[bot]' && github.event.pull_request != null
    steps:
      - name: ðŸ“¥ Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: â³ Wait for required checks
        id: wait-checks
        run: |
          echo "â³ Waiting for required CI and security checks..."

          # Required checks (must match job names in ci.yaml and security.yaml)
          REQUIRED_CHECKS=(
            "ðŸ§¹ Biome (Lint + Format)"
            "ðŸ§ª TypeScript Checks"
            "ðŸš€ Build"
            "ðŸ›¡ï¸ OSV Vulnerability Scan (PR Diff)"
            "ðŸ“œ License Compliance Check"
          )

          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            ALL_SUCCESS=true

            for check in "${REQUIRED_CHECKS[@]}"; do
              STATUS=$(gh pr checks "$PR_NUMBER" --json name,state --jq ".[] | select(.name == \"$check\") | .state" 2>/dev/null || echo "PENDING")

              if [ "$STATUS" == "FAILURE" ]; then
                echo "âŒ Check failed: $check"
                echo "checks_passed=false" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATUS" != "SUCCESS" ]; then
                ALL_SUCCESS=false
              fi
            done

            if [ "$ALL_SUCCESS" = true ]; then
              echo "âœ… All required checks passed"
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "â³ Waiting for checks to complete... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "â° Timeout waiting for checks"
          echo "checks_passed=false" >> $GITHUB_OUTPUT
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Auto-merge GitHub Actions updates
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'github-actions' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          echo "ðŸ¤– Auto-merging GitHub Actions update"
          echo "ðŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ðŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Auto-merge safe npm groups
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor') &&
          (contains(steps.dependabot-metadata.outputs.dependency-names, 'typescript') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@types/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@biomejs/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, 'knip') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, 'vite-plugin-'))
        run: |
          echo "ðŸ¤– Auto-merging safe npm group update"
          echo "ðŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ðŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â­ï¸ Skip critical packages or major updates
        if: >-
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' ||
          (steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
           (contains(steps.dependabot-metadata.outputs.dependency-names, 'solid-js') ||
            contains(steps.dependabot-metadata.outputs.dependency-names, 'vite')))
        run: |
          echo "âš ï¸ Manual review required"
          echo "ðŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ðŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          echo "ðŸ“ Reason: Major update or critical package"

      - name: ðŸš¨ Notify on merge failure
        if: failure()
        run: |
          gh pr comment "$PR_NUMBER" --body "âš ï¸ **Auto-merge failed**

          Required checks did not pass or timed out. Please review manually.

          - Check CI pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Review security scan results
          - Verify no merge conflicts exist"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  workflow-bot:
    name: âš™ï¸ Auto-Merge Workflow PRs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: >-
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      contains(github.event.pull_request.labels.*.name, 'automerge')
    steps:
      - name: ðŸ”„ Queue auto-merge for workflow PR
        run: |
          set -euo pipefail
          gh pr merge --auto --squash "$PR_URL"
          echo "âœ… Auto-merge queued for workflow PR"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
