name: ðŸ”’ Security Scanning

# Responsibility: Security analysis for Node.js + pnpm project
# - OSV scanning: vulnerability detection in dependencies (via Google OSV-Scanner Action)
# - SAST: static security analysis with Semgrep
# - License compliance: verify approved licenses (MIT/ISC/BSD/Apache-2.0)
#
# Trigger: Weekly schedule + push to master + PR to master

on:
  schedule:
    - cron: "0 1 * * 0" # Weekly on Sundays at 1 AM UTC
  push:
    branches: [master]
  pull_request:
    branches: [master]
  merge_group:
    types: [checks_requested]
  workflow_dispatch:

permissions:
  # Required to upload SARIF file to CodeQL
  actions: read
  contents: read
  security-events: write

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # OSV-Scanner: Scheduled/Push scans - reports all known vulnerabilities
  osv-scan-scheduled:
    name: ðŸ›¡ï¸ OSV Vulnerability Scan (Full)
    if: ${{ github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    uses: "google/osv-scanner-action/.github/workflows/osv-scanner-reusable.yml@v2.3.1"
    permissions:
      actions: read
      contents: read
      security-events: write
    with:
      scan-args: |-
        -r
        --lockfile=pnpm-lock.yaml
        ./

  # OSV-Scanner: PR scans - only reports NEW vulnerabilities introduced in PR
  osv-scan-pr:
    name: ðŸ›¡ï¸ OSV Vulnerability Scan (PR Diff)
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'merge_group' }}
    uses: "google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@v2.3.1"
    permissions:
      actions: read
      contents: read
      security-events: write
    with:
      scan-args: |-
        -r
        --lockfile=pnpm-lock.yaml
        ./

  semgrep:
    name: ðŸ” Static Analysis (Semgrep)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ” Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: p/typescript p/javascript p/security-audit p/secrets

  license-compliance:
    name: ðŸ“œ License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ“œ Verify LICENSES directory
        run: |
          set -euo pipefail
          echo "ðŸ“œ Checking license files..."

          LICENSES_DIR="LICENSES"
          if [ ! -d "$LICENSES_DIR" ]; then
            echo "âš ï¸ LICENSES directory not found"
            exit 1
          fi

          # Check that required license files exist
          REQUIRED_LICENSES=(
            "xcom-enhanced-gallery-MIT.txt"
            "solid-js-MIT.txt"
            "heroicons-MIT.txt"
          )

          MISSING_LICENSES=()
          for license in "${REQUIRED_LICENSES[@]}"; do
            if [ ! -f "$LICENSES_DIR/$license" ]; then
              MISSING_LICENSES+=("$license")
            fi
          done

          if [ ${#MISSING_LICENSES[@]} -ne 0 ]; then
            echo "âŒ Missing license files:"
            printf '  - %s\n' "${MISSING_LICENSES[@]}"
            exit 1
          fi

          echo "âœ… All required license files present"
          ls -la "$LICENSES_DIR"

      - name: ðŸ” Check for disallowed licenses
        run: |
          set -euo pipefail
          echo "ðŸ” Checking for disallowed license content..."

          # List of disallowed license types (GPL variants, AGPL, proprietary)
          DISALLOWED_PATTERNS=(
            "GNU General Public License"
            "GNU GPL"
            "GNU AGPL"
            "AGPL-3.0"
            "GPL-2.0"
            "GPL-3.0"
            "proprietary"
            "all rights reserved"
          )

          FOUND_ISSUES=0
          for pattern in "${DISALLOWED_PATTERNS[@]}"; do
            if grep -ri "$pattern" LICENSES/ 2>/dev/null; then
              echo "âš ï¸ Found potentially disallowed license: $pattern"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo "âŒ Potential license compliance issues found"
            # Don't fail, just warn - manual review needed
          else
            echo "âœ… No disallowed license patterns found"
          fi

  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [osv-scan-scheduled, osv-scan-pr, semgrep, license-compliance]
    if: always()
    timeout-minutes: 5
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # OSV Scanner (check both scheduled and PR jobs)
          OSV_SCHEDULED="${{ needs.osv-scan-scheduled.result }}"
          OSV_PR="${{ needs.osv-scan-pr.result }}"
          if [ "$OSV_SCHEDULED" == "success" ] || [ "$OSV_PR" == "success" ]; then
            echo "| âœ… | OSV Vulnerability Scan | Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$OSV_SCHEDULED" == "failure" ] || [ "$OSV_PR" == "failure" ]; then
            echo "| âŒ | OSV Vulnerability Scan | Failed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$OSV_SCHEDULED" == "skipped" ] && [ "$OSV_PR" == "skipped" ]; then
            echo "| â­ï¸ | OSV Vulnerability Scan | Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš ï¸ | OSV Vulnerability Scan | Check required |" >> $GITHUB_STEP_SUMMARY
          fi

          # Semgrep
          if [ "${{ needs.semgrep.result }}" == "success" ]; then
            echo "| âœ… | Static Analysis (Semgrep) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš ï¸ | Static Analysis (Semgrep) | Check required |" >> $GITHUB_STEP_SUMMARY
          fi

          # License
          if [ "${{ needs.license-compliance.result }}" == "success" ]; then
            echo "| âœ… | License Compliance | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ | License Compliance | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
