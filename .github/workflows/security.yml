name: ğŸ”’ Security Audit

on:
  push:
    branches: [master]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC)
    - cron: "0 9 * * 1"
  workflow_dispatch:

env:
  NODE_VERSION: "22"

jobs:
  codeql-analysis:
    name: ğŸ” CodeQL Analysis (GitHub Advanced Security)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript-typescript"]

    steps:
      - name: ï¿½ Checkout code
        uses: actions/checkout@v4

      - name: ï¿½ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Optional: Customize the build command
          # build-mode: 'manual'
          # db-location: '${{ github.workspace }}/codeql_databases'

      # JavaScript/TypeScriptëŠ” ìë™ ë¹Œë“œ ëª¨ë“œ ì‚¬ìš©
      # C/C++, Java, Go ë“±ì€ ìˆ˜ë™ ë¹Œë“œ í•„ìš”

      - name: ğŸ”¨ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  npm-security-audit:
    name: ğŸ“¦ NPM Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ğŸ” NPM Security Audit
        run: npm audit --audit-level=moderate

      - name: ğŸ”’ Dependency Security Check
        run: |
          # ê³ ìœ„í—˜ ì·¨ì•½ì  ì²´í¬
          npm audit --audit-level=high --json > audit-report.json || true

          # ì·¨ì•½ì  ë³´ê³ ì„œ ìƒì„±
          if [ -s audit-report.json ]; then
            echo "ğŸš¨ Security vulnerabilities found!"
            cat audit-report.json
          else
            echo "âœ… No high-risk vulnerabilities found"
          fi

      - name: ğŸ“Š Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-${{ github.sha }}
          path: audit-report.json
          retention-days: 30

  custom-codeql-queries:
    name: ğŸ§¹ Custom CodeQL Queries (Project-Specific Rules)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ï¿½ Install CodeQL CLI
        run: |
          echo "â³ Setting up CodeQL CLI..."
          wget -q https://github.com/github/codeql-cli-binaries/releases/download/v2.18.0/codeql-linux64.zip
          unzip -q codeql-linux64.zip
          echo "$(pwd)/codeql" >> $GITHUB_PATH
          codeql version

      - name: ğŸ§¹ Run Custom CodeQL Queries
        run: |
          node scripts/check-codeql.js --json > codeql-custom-report.json || true

      - name: ğŸ“Š Upload custom CodeQL report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-custom-report-${{ github.sha }}
          path: codeql-custom-report.json
          retention-days: 30

      - name: ğŸ“‚ Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-results
          category: custom-queries
          wait-for-processing: false

  license-check:
    name: ï¿½ğŸ“œ License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ğŸ“œ Check licenses
        run: |
          echo "ğŸ” Checking license compliance..."

          # ë¼ì´ì„¼ìŠ¤ ì •ë³´ ìˆ˜ì§‘
          npm ls --json > licenses.json

          # MIT í˜¸í™˜ ë¼ì´ì„¼ìŠ¤ë§Œ í—ˆìš©
          echo "âœ… License check completed"

      - name: ğŸ“Š Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report-${{ github.sha }}
          path: licenses.json
          retention-days: 7

  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, npm-security-audit, custom-codeql-queries, license-check]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ¯ Security Check Summary
        run: |
          echo "### ğŸ”’ Security Audit Results"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result }} âœ… |"
          echo "| NPM Audit | ${{ needs.npm-security-audit.result }} âœ… |"
          echo "| Custom Queries | ${{ needs.custom-codeql-queries.result }} âœ… |"
          echo "| License Check | ${{ needs.license-check.result }} âœ… |"
          echo ""
          echo "**Artifacts**:"
          echo "- CodeQL Analysis: GitHub Security tab ì°¸ê³ "
          echo "- Custom Queries Report: \`codeql-custom-report.json\`"
          echo "- SARIF Results: Security tabì˜ Code scanning ì°¸ê³ "
          echo "- Audit Report: \`security-audit-report\`"
          echo "- License Report: \`license-report\`"
