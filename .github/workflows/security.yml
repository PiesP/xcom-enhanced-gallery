name: ğŸ”’ Security Audit

# Responsibility: Dedicated security monitoring (weekly schedule + on-demand)
# - npm audit: dependency vulnerabilities
# - license-checker: license compliance
# Separate from ci.yml to avoid blocking PRs with security alerts

on:
  push:
    branches: [master]
  schedule:
    # Every Monday 9 AM (UTC)
    - cron: "0 9 * * 1"
  workflow_dispatch:

env:
  NODE_VERSION: "24"
  XEG_DISABLE_LOCAL_CONFIG: "true"

jobs:
  security-audit:
    name: ğŸ” Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ğŸ” NPM Security Audit
        run: npm audit --audit-level=moderate

      - name: ğŸ”’ Dependency Security Check
        run: |
          # High-risk vulnerability check
          npm audit --audit-level=high --json > audit-report.json || true

          # Generate vulnerability report
          if [ -s audit-report.json ]; then
            echo "ğŸš¨ Security vulnerabilities found!"
            cat audit-report.json
          else
            echo "âœ… No high-risk vulnerabilities found"
          fi

      - name: ğŸ›¡ï¸ GitHub Security Surface Check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const dashboardUrl = `https://github.com/${owner}/${repo}/security`;
            const maxSamples = 3;

            const normalize = (value) => {
              if (!value) {
                return 'unknown';
              }
              const normalized = String(value).trim().toLowerCase();
              return normalized || 'unknown';
            };

            const sources = [
              {
                kind: 'Code Scanning Alerts',
                fetch: () => github.paginate('GET /repos/{owner}/{repo}/code-scanning/alerts', {
                  owner,
                  repo,
                  state: 'open',
                  per_page: 100,
                }),
                severity: (alert) => alert?.rule?.security_severity_level ?? alert?.rule?.severity ?? alert?.severity ?? 'unknown',
                label: (alert) => alert?.rule?.description ?? alert?.rule?.name ?? alert?.rule?.id ?? alert?.tool?.name ?? (alert?.number ? `Alert #${alert.number}` : undefined),
              },
              {
                kind: 'Dependabot Alerts',
                fetch: () => github.paginate('GET /repos/{owner}/{repo}/dependabot/alerts', {
                  owner,
                  repo,
                  state: 'open',
                  per_page: 100,
                }),
                severity: (alert) => alert?.security_advisory?.severity ?? 'unknown',
                label: (alert) => {
                  const pkg = alert?.dependency?.package?.name ?? 'dependency';
                  const manifest = alert?.dependency?.manifest_path ?? 'manifest';
                  return `${pkg} (${manifest})`;
                },
              },
              {
                kind: 'Secret Scanning Alerts',
                fetch: () => github.paginate('GET /repos/{owner}/{repo}/secret-scanning/alerts', {
                  owner,
                  repo,
                  state: 'open',
                  per_page: 100,
                }),
                severity: (alert) => alert?.secret_type_display_name ?? alert?.secret_type ?? 'unknown',
                label: (alert) => alert?.secret_type_display_name ?? alert?.secret_type ?? (alert?.number ? `Secret #${alert.number}` : undefined),
              },
            ];

            const summaries = [];
            const warnings = [];

            for (const source of sources) {
              try {
                const alerts = await source.fetch();
                const severityCounts = new Map();
                const samples = [];

                for (const alert of alerts) {
                  const severity = normalize(source.severity(alert));
                  severityCounts.set(severity, (severityCounts.get(severity) ?? 0) + 1);

                  if (samples.length < maxSamples) {
                    const label = source.label(alert);
                    if (label) {
                      samples.push(label);
                    }
                  }
                }

                const severityBreakdown = Array.from(severityCounts.entries())
                  .sort((a, b) => {
                    if (b[1] !== a[1]) {
                      return b[1] - a[1];
                    }
                    return a[0].localeCompare(b[0]);
                  })
                  .map(([severity, count]) => `${severity}=${count}`);

                summaries.push({
                  kind: source.kind,
                  total: alerts.length,
                  severityBreakdown,
                  samples,
                });
              } catch (error) {
                warnings.push(`Failed to query ${source.kind}: ${error.message}`);
              }
            }

            if (warnings.length > 0) {
              warnings.forEach(message => core.warning(message));
            }

            if (summaries.length === 0) {
              core.notice('GitHub Security scan: no alert data returned from GitHub API.');
              return;
            }

            core.startGroup('GitHub Security Surface Summary');
            summaries.forEach(summary => {
              const severityText = summary.severityBreakdown.length > 0 ? summary.severityBreakdown.join(', ') : 'no severity data';
              const samplesText = summary.samples.length > 0 ? ` Samples: ${summary.samples.join(' | ')}` : '';
              core.info(`${summary.kind} â†’ ${summary.total} alert(s) [${severityText}].${samplesText}`);
            });
            core.endGroup();

            const blocking = summaries.filter(summary => summary.total > 0);
            if (blocking.length === 0) {
              core.notice('GitHub Security surface clean (no open alerts detected).');
              return;
            }

            blocking.forEach(summary => {
              const severityText = summary.severityBreakdown.length > 0 ? summary.severityBreakdown.join(', ') : 'no severity data';
              const samplesText = summary.samples.length > 0 ? ` Samples: ${summary.samples.join(' | ')}` : '';
              core.error(`${summary.kind}: ${summary.total} open alert(s). Severities: ${severityText}.${samplesText}`);
            });

            core.setFailed(`Open GitHub security alerts detected. Review ${dashboardUrl} for details.`);

      - name: ğŸ“Š Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-${{ github.sha }}
          path: audit-report.json
          retention-days: 30

  license-check:
    name: ğŸ“œ License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ğŸ“œ Check licenses
        run: |
          echo "ğŸ” Checking license compliance..."

          # Collect license information
          npm ls --json > licenses.json

          # Allow only MIT-compatible licenses
          echo "âœ… License check completed"

      - name: ğŸ“Š Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report-${{ github.sha }}
          path: licenses.json
          retention-days: 7

  codeql-scan:
    name: ğŸ§  CodeQL Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: âš™ï¸ Autobuild project
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š Analyze with CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: '/github/workflow/security'
