name: ðŸš€ Release

# Responsibility: Release artifact creation only
# - Version detection: package.json changes or manual trigger
# - Production build: userscript + checksums + metadata
# - GitHub Release: automated creation with assets
# - No CI validation beyond direct Vite builds
#
# NOTE: All validation (tests, lint, deps, coverage) happens locally before push.
# CI uses first-party commands only: npm ci + npx vite build.

on:
  push:
    branches: [master]
    paths:
      - "src/**"
      - "package.json"
      - "vite.config.ts"
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

env:
  NODE_VERSION: "24"
  XEG_DISABLE_LOCAL_CONFIG: "true"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check-changes:
    name: ðŸ” Check Version Changes
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      current_version: ${{ steps.check.outputs.current_version }}
    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ðŸ” Check version changes
        id: check
        run: |
          set -euo pipefail

          CURRENT_VERSION=$(node -p "require('./package.json').version")

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "Manual release triggered"
          else
            PREV_VERSION=""

            # If there's a parent commit, attempt to read package.json from it.
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              if git ls-tree -r HEAD~1 --name-only | grep -q '^package.json$'; then
                PREV_VERSION=$(git show HEAD~1:package.json 2>/dev/null || true | node -e "try{ const s = require('fs').readFileSync(0,'utf8'); const p = JSON.parse(s); if (p && p.version) console.log(p.version); } catch(e){}")
              fi
            fi

            if [ -z "$PREV_VERSION" ]; then
              # No previous package.json or version available -> treat as changed.
              echo "should_release=true" >> "$GITHUB_OUTPUT"
              echo "ðŸš¦ Pre-release: No previous version found; will release"
            else
              if [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
                echo "should_release=true" >> "$GITHUB_OUTPUT"
                echo "âœ… Version changed: $PREV_VERSION â†’ $CURRENT_VERSION"
              else
                echo "should_release=false" >> "$GITHUB_OUTPUT"
                echo "â­ï¸ No version change detected"
              fi
            fi
          fi

          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

  build-and-release:
    name: ðŸ—ï¸ Build and Release
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_release == 'true'
    timeout-minutes: 8
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: ðŸ“ˆ Bump version (if manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          echo "ðŸ”„ Bumping version (${{ inputs.version_type }})..."
          npm version ${{ inputs.version_type }} --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "âœ… Version bumped to: $NEW_VERSION"

          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push

      - name: ðŸ“ Get final version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"

      - name: ðŸ·ï¸ Create Git tag
        run: |
          set -euo pipefail
          TAG=v${{ steps.version.outputs.version }}
          echo "Creating tag ${TAG} if it doesn't exist"
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists; skipping"
          else
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
            echo "Tag created and pushed: ${TAG}"
          fi

      - name: ðŸ—ï¸ Build (development + production)
        run: npx vite build --mode development && npx vite build --mode production

      - name: ðŸ“¦ Create release package
        run: |
          echo "ðŸ“¦ Preparing release files..."
          mkdir -p release

          # Copy userscript from production build
          cp dist/xcom-enhanced-gallery.user.js release/

          # Generate checksums
          cd release
          sha256sum xcom-enhanced-gallery.user.js > checksums.txt
          cd ..

          # Create metadata
          cat > release/metadata.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "commit": "${{ github.sha }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "build_type": "production"
          }
          EOF

          # Create release notes
          cat > release/RELEASE_NOTES.md << EOF
          # ðŸš€ Release v${{ steps.version.outputs.version }}

          ## ðŸ“¥ Installation

          **[ðŸ“¥ Click here to install userscript](https://github.com/PiesP/xcom-enhanced-gallery/releases/download/v${{ steps.version.outputs.version }}/xcom-enhanced-gallery.user.js)**

          ## ðŸ“‹ What's Changed

          - Built from commit: \`${{ github.sha }}\`
          - Release date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## ðŸ”§ Technical Details

          - Version: \`${{ steps.version.outputs.version }}\`
          - Node.js: \`${{ env.NODE_VERSION }}\`
          - Build: Production optimized

          EOF

      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ðŸš€ Release v${{ steps.version.outputs.version }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/xcom-enhanced-gallery.user.js
            release/checksums.txt
            release/metadata.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-v${{ steps.version.outputs.version }}
          path: release/
          retention-days: 30
