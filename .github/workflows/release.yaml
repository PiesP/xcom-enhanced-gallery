name: ðŸš€ Release

# Responsibility: Release artifact creation only
# - Version detection: package.json version change or manual trigger
# - Production build: userscript + checksums + metadata
# - GitHub Release: automated creation with downloadable assets
#
# Note: All validation (tests, lint, deps) happens locally before push.

on:
  push:
    branches: [master]
    paths:
      - "src/**"
      - "package.json"
      - "vite.config.ts"
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      skip_ci_check:
        description: "Skip CI status check"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "24"
  XEG_DISABLE_LOCAL_CONFIG: "true"

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check-version:
    name: ðŸ” Check Version
    runs-on: ubuntu-slim
    timeout-minutes: 5
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: ðŸ” Detect version change
        id: check
        run: |
          set -euo pipefail
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Manual release triggered"
          else
            PREV_VERSION=""
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              if git ls-tree -r HEAD~1 --name-only | grep -q '^package.json$'; then
                PREV_VERSION=$(git show HEAD~1:package.json 2>/dev/null | node -e "
                  try {
                    const s = require('fs').readFileSync(0,'utf8');
                    const p = JSON.parse(s);
                    if (p?.version) console.log(p.version);
                  } catch(e) {}
                " || true)
              fi
            fi

            if [ -z "$PREV_VERSION" ]; then
              echo "should_release=true" >> "$GITHUB_OUTPUT"
              echo "ðŸš¦ No previous version found; will release"
            elif [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
              echo "should_release=true" >> "$GITHUB_OUTPUT"
              echo "âœ… Version changed: $PREV_VERSION â†’ $CURRENT_VERSION"
            else
              echo "should_release=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ No version change detected"
            fi
          fi

          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

  build-release:
    name: ðŸ—ï¸ Build & Release
    runs-on: ubuntu-slim
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            .vite
          key: vite-${{ runner.os }}-${{ hashFiles('package-lock.json', 'vite.config.ts') }}
          restore-keys: |
            vite-${{ runner.os }}-

      - name: ðŸ“ˆ Bump version (manual only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          echo "ðŸ”„ Bumping version (${{ inputs.version_type }})..."
          npm version ${{ inputs.version_type }} --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "âœ… Version bumped to: $NEW_VERSION"

          git add package.json package-lock.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push

      - name: ðŸ“ Get release version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"

      - name: ðŸ·ï¸ Create Git tag
        run: |
          set -euo pipefail
          TAG=v${{ steps.version.outputs.version }}
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists; skipping"
          else
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
            echo "âœ… Tag created: ${TAG}"
          fi

      - name: ðŸ—ï¸ Build userscript
        run: |
          npx vite build --mode development
          npx vite build --mode production

      - name: ðŸ“¦ Prepare release package
        run: |
          mkdir -p release
          cp dist/xcom-enhanced-gallery.user.js release/

          # Generate checksums
          cd release && sha256sum xcom-enhanced-gallery.user.js > checksums.txt && cd ..

          # Create metadata
          cat > release/metadata.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "commit": "${{ github.sha }}",
            "node_version": "${{ env.NODE_VERSION }}"
          }
          EOF

          # Extract changelog for current version
          CHANGELOG_CONTENT=""
          if [ -f "CHANGELOG.md" ]; then
            # Extract content between [version] and next [version] or end
            CHANGELOG_CONTENT=$(awk -v ver="${{ steps.version.outputs.version }}" '
              /^## \[/ {
                if (found) exit;
                if ($0 ~ "\\[" ver "\\]") {
                  found=1;
                  next;
                }
              }
              found { print }
            ' CHANGELOG.md)
          fi

          # Create release notes with changelog content
          cat > release/RELEASE_NOTES.md << EOF
          # ðŸš€ Release v${{ steps.version.outputs.version }}

          ## ðŸ“¥ Installation

          **[ðŸ“¥ Click here to install](https://github.com/PiesP/xcom-enhanced-gallery/releases/download/v${{ steps.version.outputs.version }}/xcom-enhanced-gallery.user.js)**

          ---

          ## ðŸ“ What's Changed

          ${CHANGELOG_CONTENT:-No changelog entry found for this version.}

          **[ðŸ“‹ Full Changelog](https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.version }}...HEAD)**

          ---

          ## ðŸ“‹ Build Details

          - **Commit**: \`${{ github.sha }}\`
          - **Built**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Node.js**: \`${{ env.NODE_VERSION }}\`
          EOF

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/xcom-enhanced-gallery.user.js
            release/checksums.txt
            release/metadata.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Upload release artifacts
        uses: actions/upload-artifact@v5
        with:
          name: release-v${{ steps.version.outputs.version }}
          path: release/
          retention-days: 30
