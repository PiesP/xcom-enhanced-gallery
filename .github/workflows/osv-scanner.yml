# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# A sample workflow which sets up periodic OSV-Scanner scanning for vulnerabilities,
# in addition to a PR check which fails if new vulnerabilities are introduced.
#
# For more examples and options, including how to ignore specific vulnerabilities,
# see https://google.github.io/osv-scanner/github-action/

name: OSV-Scanner

on:
  pull_request:
    branches: [ "master" ]
  merge_group:
    branches: [ "master" ]
  schedule:
    - cron: '41 6 * * 1'
  push:
    branches: [ "master" ]

env:
  OSV_SCANNER_VERSION: v2.3.0
  OSV_SCANNER_URL: https://github.com/google/osv-scanner/releases/download/v2.3.0/osv-scanner_linux_amd64
  OSV_SCANNER_SHA256: e774e5770c31d60745c067be5f69bf3b46641b6d0e0ed87fd65e569cda35dc50
  OSV_RESULTS_FILE: results.sarif

permissions:
  actions: read
  security-events: write
  contents: read

jobs:
  scan-scheduled:
    if: ${{ github.event_name == 'push' || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Download OSV-Scanner CLI
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.local/bin"
          curl -sSLo "${RUNNER_TEMP}/osv-scanner" "${OSV_SCANNER_URL}"
          echo "${OSV_SCANNER_SHA256}  ${RUNNER_TEMP}/osv-scanner" | sha256sum --check --status
          install -m 0755 "${RUNNER_TEMP}/osv-scanner" "${HOME}/.local/bin/osv-scanner"

      - name: Add local bin to PATH
        run: echo "${HOME}/.local/bin" >> "$GITHUB_PATH"

      - name: Print OSV-Scanner version
        run: osv-scanner --version

      - name: Run OSV scan
        id: run-osv-scan
        continue-on-error: true
        run: |
          set -euo pipefail
          osv-scanner scan source \
            --recursive \
            --format sarif \
            --output "${OSV_RESULTS_FILE}" \
            ./

      - name: Upload SARIF artifact
        if: ${{ always() && hashFiles(env.OSV_RESULTS_FILE) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: OSV-sarif-${{ github.job }}-${{ github.run_number }}
          path: ${{ env.OSV_RESULTS_FILE }}
          retention-days: 5

      - name: Upload to code scanning
        if: ${{ always() && hashFiles(env.OSV_RESULTS_FILE) != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.OSV_RESULTS_FILE }}

      - name: Fail on vulnerabilities
        if: steps.run-osv-scan.outcome == 'failure'
        run: |
          echo "::error::OSV-Scanner reported vulnerabilities or errors. Review the SARIF artifact for more details."
          exit 1

  scan-pr:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'merge_group' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download OSV-Scanner CLI
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.local/bin"
          curl -sSLo "${RUNNER_TEMP}/osv-scanner" "${OSV_SCANNER_URL}"
          echo "${OSV_SCANNER_SHA256}  ${RUNNER_TEMP}/osv-scanner" | sha256sum --check --status
          install -m 0755 "${RUNNER_TEMP}/osv-scanner" "${HOME}/.local/bin/osv-scanner"

      - name: Add local bin to PATH
        run: echo "${HOME}/.local/bin" >> "$GITHUB_PATH"

      - name: Print OSV-Scanner version
        run: osv-scanner --version

      - name: Run OSV scan
        id: run-osv-scan
        continue-on-error: true
        run: |
          set -euo pipefail
          osv-scanner scan source \
            --recursive \
            --format sarif \
            --output "${OSV_RESULTS_FILE}" \
            ./

      - name: Upload SARIF artifact
        if: ${{ always() && hashFiles(env.OSV_RESULTS_FILE) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: OSV-sarif-${{ github.job }}-${{ github.run_number }}
          path: ${{ env.OSV_RESULTS_FILE }}
          retention-days: 5

      - name: Upload to code scanning
        if: ${{ always() && hashFiles(env.OSV_RESULTS_FILE) != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.OSV_RESULTS_FILE }}

      - name: Fail on vulnerabilities
        if: steps.run-osv-scan.outcome == 'failure'
        run: |
          echo "::error::OSV-Scanner reported vulnerabilities or errors. Review the SARIF artifact for more details."
          exit 1
