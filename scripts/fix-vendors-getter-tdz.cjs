/**
 * Î™®Îì† ÌååÏùºÏóêÏÑú ÌååÏùº ÏµúÏÉÅÎã® vendors getter Ìò∏Ï∂úÏùÑ Ìï®Ïàò ÎÇ¥Î∂ÄÎ°ú Ïù¥ÎèôÌïòÎäî Ïä§ÌÅ¨Î¶ΩÌä∏
 *
 * Î¨∏Ï†ú:
 * import { getSolid } from '@shared/external/vendors';
 * const { createSignal } = getSolid();  // ‚ùå ÌååÏùº Î°úÎìú ÏãúÏ†êÏóê Ï¶âÏãú Ïã§Ìñâ
 *
 * Ìï¥Í≤∞:
 * export function MyComponent() {
 *   const { createSignal } = getSolid();  // ‚úÖ Ìï®Ïàò Ïã§Ìñâ ÏãúÏ†êÏóê Ìò∏Ï∂ú
 * }
 */

const fs = require('fs');
const path = require('path');
const { glob } = require('glob');

// ÏàòÏ†ï ÎåÄÏÉÅ ÌååÏùº Ìå®ÌÑ¥
const patterns = [
  'src/shared/primitives/*.ts',
  'src/shared/components/ui/**/*.tsx',
  'src/features/**/*.tsx',
];

// vendors getter Ìå®ÌÑ¥ (ÌååÏùº ÏµúÏÉÅÎã®ÏóêÏÑú Ï¶âÏãú Ìò∏Ï∂ú)
const IMMEDIATE_CALL_PATTERN =
  /^(import \{ (?:get\w+) \} from '@shared\/external\/vendors';)\n(const \{ [^}]+ \} = (?:get\w+)\(\);)/gm;

let fixedCount = 0;
let errorCount = 0;

async function fixFile(filePath) {
  try {
    let content = fs.readFileSync(filePath, 'utf-8');

    // Ïù¥ÎØ∏ ÏàòÏ†ïÎêú ÌååÏùºÏùÄ Ïä§ÌÇµ
    if (!IMMEDIATE_CALL_PATTERN.test(content)) {
      return false;
    }

    // Î∞±ÏóÖ ÏÉùÏÑ±
    const backupPath = filePath + '.backup';
    fs.writeFileSync(backupPath, content);

    console.log(`\nüîß Fixing: ${filePath}`);
    console.log('   ‚ö†Ô∏è  Found immediate vendor getter call at file top');

    // Ìå®ÌÑ¥ Îß§Ïπ≠ Í≤∞Í≥º ÌôïÏù∏
    content = content.replace(IMMEDIATE_CALL_PATTERN, (match, importLine, constLine) => {
      console.log(`   ‚úì  Removing: ${constLine}`);
      return importLine; // importÎßå Ïú†ÏßÄ, const Ï†úÍ±∞
    });

    fs.writeFileSync(filePath, content);
    console.log('   ‚úÖ Fixed - manual component/function update needed');

    fixedCount++;
    return true;
  } catch (error) {
    console.error(`‚ùå Error fixing ${filePath}:`, error.message);
    errorCount++;
    return false;
  }
}

async function main() {
  console.log('üöÄ Starting vendors getter fix...\n');

  for (const pattern of patterns) {
    console.log(`\nüìÇ Processing pattern: ${pattern}`);
    const files = await glob(pattern, { cwd: process.cwd() });

    console.log(`   Found ${files.length} files`);

    for (const file of files) {
      await fixFile(file);
    }
  }

  console.log('\n' + '='.repeat(60));
  console.log(`‚úÖ Fixed: ${fixedCount} files`);
  console.log(`‚ùå Errors: ${errorCount} files`);
  console.log('='.repeat(60));

  if (fixedCount > 0) {
    console.log('\n‚ö†Ô∏è  IMPORTANT: You must manually add vendor getter calls');
    console.log('   inside each component/function body!');
    console.log('\n   Example:');
    console.log('   export function MyComponent() {');
    console.log('     const { createSignal } = getSolid(); // ‚Üê Add this');
    console.log('     // ... rest of code');
    console.log('   }');
  }
}

main().catch(console.error);
