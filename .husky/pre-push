#!/usr/bin/env sh

# Pre-push: íƒ€ì… ì²´í¬ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì„ íƒì  ë²”ìœ„)
#
# ì—­í• : push ì „ ì½”ë“œ í’ˆì§ˆ ê²€ì¦ (typecheck + tests)
# CI ìŠ¤í‚µ: ì „ì²´ ê²€ì¦ì€ GitHub Actionsì—ì„œ ì‹¤í–‰
#
# ë²”ìœ„ ì„¤ì • ìš°ì„ ìˆœìœ„:
#   1. í™˜ê²½ ë³€ìˆ˜: XEG_PREPUSH_SCOPE (ê°€ì¥ ë†’ìŒ)
#   2. git config: xeg.prepushScope (ì¤‘ê°„)
#   3. ê¸°ë³¸ê°’: smoke (ê°€ì¥ ë‚®ìŒ, ê°€ì¥ ë¹ ë¦„)
#
# ì‚¬ìš© ì˜ˆì‹œ:
#   export XEG_PREPUSH_SCOPE=full && git push    # ì „ì²´ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰
#   git config xeg.prepushScope fast && git push # git config ì €ì¥
#   git push                                      # ê¸°ë³¸ê°’(smoke) ì‹¤í–‰
#
# ì°¸ê³ : AGENTS.mdì˜ "ë¶„í•  ì‹¤í–‰(Projects)" ì„¹ì…˜ ì°¸ê³ 

if [ "$CI" = "true" ]; then
  echo "â­ï¸  Pre-push: CI í™˜ê²½ì—ì„œ ìŠ¤í‚µë¨ (GitHub Actionsì—ì„œ ê²€ì¦)"
  exit 0
fi

# ë²”ìœ„ í•´ì„: í™˜ê²½ ë³€ìˆ˜ > git config > ê¸°ë³¸ê°’
SCOPE="${XEG_PREPUSH_SCOPE:-}"
if [ -z "$SCOPE" ]; then
  CFG_SCOPE=$(git config --get xeg.prepushScope 2>/dev/null || true)
  if [ -n "$CFG_SCOPE" ]; then
    SCOPE="$CFG_SCOPE"
  else
    SCOPE="smoke"
  fi
fi

echo "ğŸ§ª Pre-push: íƒ€ì… ì²´í¬ + í…ŒìŠ¤íŠ¸ (ë²”ìœ„: $SCOPE)"

# íƒ€ì… ì²´í¬ (tsgo - ë¹ ë¥¸ TypeScript ì²´ì»¤)
npm run typecheck || {
  echo "âŒ íƒ€ì… ì²´í¬ ì‹¤íŒ¨"
  exit 1
}

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë²”ìœ„ì— ë”°ë¼)
if [ "$SCOPE" = "full" ] || [ "$SCOPE" = "all" ]; then
  npm run test || {
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì „ì²´ ìŠ¤ìœ„íŠ¸)"
    exit 1
  }
else
  npm run test:$SCOPE || {
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë²”ìœ„: $SCOPE)"
    echo ""
    echo "ğŸ’¡ íŒ:"
    echo "   export XEG_PREPUSH_SCOPE=full && git push    # ì „ì²´ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰"
    echo "   git config xeg.prepushScope fast && git push # git config ì €ì¥"
    exit 1
  }
fi

echo "âœ… Pre-push ê²€ì¦ í†µê³¼"
exit 0
