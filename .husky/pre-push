#!/usr/bin/env sh
# Pre-push Hook: TypeCheck + Configurable Tests
# ==============================================
# Purpose: Ensures code quality before pushing to remote
#
# Validation Scopes (priority order):
#   1. Environment: XEG_PREPUSH_SCOPE (one-time override)
#   2. Git config: xeg.prepushScope (persistent preference)
#   3. Default: smoke (fast, ~20-30 seconds)
#
# Scope Details:
#   - smoke: Quick E2E tests (Playwright smoke tests) - ~20-30s (DEFAULT)
#   - fast: Unit + Smoke tests (minimal coverage) - ~45-60s
#   - unit: All unit tests (Jest/Vitest) - ~60-90s
#   - full|all: Complete test suite (unit + browser + E2E) - ~5-10min
#
# Usage Examples:
#   # One-time override (full suite)
#   export XEG_PREPUSH_SCOPE=full && git push
#
#   # Save preference for future pushes
#   git config xeg.prepushScope fast
#   git push  # Uses 'fast' scope
#
#   # Override saved preference
#   export XEG_PREPUSH_SCOPE=full && git push
#
#   # Reset to default (smoke)
#   git config --unset xeg.prepushScope
#   git push  # Uses default 'smoke' scope
#
# Behavior:
#   - Skipped in CI environments (GitHub Actions handles full validation)
#   - Always runs TypeScript type checking first
#   - Failures block the push
#   - Reports scope used for transparency
#
# Performance Impact:
#   - Local development: Fast by default (smoke ~30s)
#   - Before merge: Use 'full' for comprehensive coverage
#   - CI/CD: 100% test suite always runs (independent of hooks)
#
# For details: See AGENTS.md > Git Hooks & ARCHITECTURE.md

[ "$CI" = "true" ] && exit 0

# Determine validation scope (priority: env var > git config > default)
SCOPE="${XEG_PREPUSH_SCOPE:-$(git config --get xeg.prepushScope 2>/dev/null || echo smoke)}"

echo "ğŸ§ª Pre-push validation"
echo "   Scope: $SCOPE"
echo "   â€¢ TypeScript: type checking"
echo "   â€¢ Tests: $SCOPE suite"
echo ""

# Step 1: TypeScript Type Checking (always runs)
echo "ğŸ“¦ Checking types..."
npm run typecheck || {
  echo "âŒ TypeScript validation failed. Fix errors and try again."
  exit 1
}

# Step 2: Run tests based on scope
echo "ğŸ§ª Running tests ($SCOPE)..."
case "$SCOPE" in
  full|all)
    # Complete test suite: unit + browser + E2E
    npm test || {
      echo "âŒ Full test suite failed. Fix errors and try again."
      exit 1
    }
    ;;
  unit|fast|smoke)
    # Named test project (fast, unit, smoke)
    npm run "test:$SCOPE" || {
      echo "âŒ Test suite ($SCOPE) failed. Fix errors and try again."
      exit 1
    }
    ;;
  *)
    # Unknown scope - fall back to smoke
    echo "âš ï¸  Unknown scope '$SCOPE', using 'smoke' (default)"
    npm run test:smoke || {
      echo "âŒ Smoke tests failed. Fix errors and try again."
      exit 1
    }
    ;;
esac

echo ""
echo "âœ… Pre-push validation passed"
echo "   â€¢ TypeScript: âœ“"
echo "   â€¢ Tests ($SCOPE): âœ“"
echo ""
