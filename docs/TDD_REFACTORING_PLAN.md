# 🎨 TDD 리팩토링 계획 — Userscript 소스 현대화(차기 사이클)

> 테스트 우선(TDD)으로 Userscript 소스를 더 간결·일관·현대적으로
> 유지/고도화합니다. 완료된 항목은 `TDD_REFACTORING_PLAN_COMPLETED.md`에서만
> 관리합니다.

## 범위와 가드레일

- TypeScript strict 100%, 모든 함수 명시적 타입
- 외부 의존성은 getter 함수로만 접근(Preact, Signals, fflate, GM\_\*)
- PC 전용 입력만 사용(Mouse/Keyboard/Wheel)
- 디자인 토큰 100% 사용(색/시간/라디우스 하드코딩 금지)

## 적용 가능한 솔루션 비교(요약·선택 포함)

- 스타일 소스 오브 트루스
  - 대안 A: JS 상수(CSS.SPACING 등) 병행 — 스타일/컴포넌트 분리로 불일치 위험↑
  - 대안 B(선택·현행): CSS Semantic 토큰 단일화 — 단일 출처, 정적 검사/테스트
    용이
- 이벤트/핫키 처리
  - 대안 A: 각 컴포넌트 분산 처리 — 중복/충돌 가능, 테스트 난이도↑
  - 대안 B(선택·현행): 중앙 Keybinding + PC-only 가드 — 일관성·테스트 용이성↑
- 외부 의존성 접근
  - 대안 A: 직접 import — 모킹/교체 어려움, 테스트 취약
  - 대안 B(선택·현행): vendor getter + 주입 — 의존성 격리/모킹 용이
- 미디어 추출/정규화
  - 대안 A: ad-hoc 정규식 호출 — 예외 처리 분산, 회귀 위험↑
  - 대안 B(선택·현행): 정책 엔진 + 정규화 유틸 — 규칙 중심, 테스트/확장 용이
- 로깅/에러 처리
  - 대안 A: console 기반 — 상관관계/레벨 제어 한계
  - 대안 B(선택·현행): 구조화 로거 + correlationId — 디버깅/진단 정확도↑
- 번들/사이즈 거버넌스
  - 대안 A: best-effort — 사이즈 회귀 탐지 어려움
  - 대안 B(선택): 사이즈 예산 + 번들 분석 리포트 — 회귀 차단, CI 가시성↑

## 리팩토링 단계(테스트 우선)

아래 항목은 신규 사이클에 수행할 계획입니다. 각 단계는 RED → GREEN → 리팩토링
순으로 진행합니다.

1. Phase E — 서비스 계약 고도화/순수 함수화

- 목표: Media/Download/Toast/Settings의 공개 계약(Interface) 명시, Result 패턴
  일관화, 부수효과 어댑터로 격리(GM\_\*, DOM).
- RED: 서비스 경계 스냅샷 테스트(타입/시그니처), 실패 경로(Result.error) 계약
  테스트.
- GREEN: 최소 구현/어댑터 추출 및 모킹 테스트 통과.
- 리팩토링: 내부 구현 정리(함수형 유틸 분리), 문서화.

3. Phase I — 오류 복구 UX 표준화(Toast/Retry)

- 목표: 추출/다운로드 실패 UX 통일(요약/재시도/취소), 사용자 피드백 일관화.
- RED: 실패 요약/재시도/취소 플로우 테스트.
- GREEN: 구현 후 회귀 스위트 GREEN.
- 리팩토링: 메시지/로깅 스키마 통일.

## 완료 기준(DoD)

- 각 Phase RED→GREEN, 회귀 테스트 유지
- getter-only 의존성, PC 전용 입력, 토큰 사용 위반 0건
- 문서/체인지로그 갱신 및 사이즈 예산 준수(경고 ≥ 300KB, 실패 > 450KB; 추후
  프로젝트 합의로 조정 가능)

## 진행/이관 노트

- 이전 사이클의 완료 항목은 모두 `TDD_REFACTORING_PLAN_COMPLETED.md`로
  이관되었습니다(본 문서에는 진행 중/계획 항목만 유지).

## What's next (요약)

- Phase E: 서비스 계약 고도화/순수 함수화 — 인터페이스 명시 및 Result 패턴
  일관화, GM\_\*/DOM 부수효과 분리-어댑터화. 계약 스냅샷 테스트부터 RED.
- Phase I: 오류 복구 UX 표준화 — 실패 요약/재시도/취소 UX 통일과 로깅 스키마
  일치.
