# Phase 425: Scroll Recovery Protection Enhancement

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-07 | **ìƒíƒœ**: âœ… **ì™„ë£Œ** | **ë²„ì „**: v0.4.3+ |
**ì–¸ì–´**: í•œêµ­ì–´ (ë³´ê³ ì„œ), ì˜ì–´ (ì½”ë“œ)

---

## ğŸ¯ ì‘ì—… ìš”ì•½

Phase 424ì˜ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ, íƒ€ì„ë¼ì¸ ê¹Šì´ íƒìƒ‰ í›„ ìŠ¤í¬ë¡¤ ë³µì› ì‹¤íŒ¨ ë¬¸ì œë¥¼
í•´ê²°í•˜ê¸° ìœ„í•œ 3ê°€ì§€ ìµœì í™”ë¥¼ êµ¬í˜„í•˜ê³  `npm run build`ë¡œ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.

---

## âœ… êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### 1. í¬ì»¤ìŠ¤ íŠ¸ë© Scroll Recovery ë³´í˜¸ (focus-trap.ts)

**íŒŒì¼**: `src/shared/utils/focus-trap.ts`

**ë³€ê²½ ë‚´ìš©**:

```typescript
// Phase 425: Scroll recovery ì¤‘ í¬ì»¤ìŠ¤ ì´ë™ ì°¨ë‹¨
function activate(): void {
  // 1. ì „ì—­ í”Œë˜ê·¸ í™•ì¸: __XEG_SCROLL_RECOVERY_ACTIVE__
  const scrollRecoveryWindow = (window as unknown as Record<string, unknown>)
    .__XEG_SCROLL_RECOVERY_ACTIVE__;

  // 2. í™œì„± ì¤‘ì´ë©´ 350ms í›„ ì¬ì‹œë„
  if (scrollRecoveryWindow === true) {
    const deferralTimer = globalThis.setTimeout(() => {
      activate(); // Retry
    }, 350);
    return;
  }

  // 3. í‰ìƒì‹œì²˜ëŸ¼ í¬ì»¤ìŠ¤ íŠ¸ë© ì‹¤í–‰
  focusFirstElement();
  isActive = true;
}
```

**íš¨ê³¼**:

- ğŸŸ¢ Scroll recovery ì¤‘ í¬ì»¤ìŠ¤ ì´ë™ìœ¼ë¡œ ì¸í•œ ìŠ¤í¬ë¡¤ ì¤‘ë‹¨ ë°©ì§€
- ğŸŸ¢ ë©”ì¸ ìŠ¤ë ˆë“œ ê²½í•© ê°ì†Œ (í¬ì»¤ìŠ¤ ë³€ê²½ ì‘ì—… ì—°ê¸°)
- ğŸŸ¢ Twitterì˜ ìŠ¤í¬ë¡¤ ë³µì› ìš°ì„ ìˆœìœ„ ë³´ì¥

---

### 2. ìŠ¤í¬ë¡¤ ë³µì› ìœˆë„ìš° í™•ì¥ (gallery-lifecycle.ts)

**íŒŒì¼**: `src/shared/utils/events/lifecycle/gallery-lifecycle.ts`

**ë³€ê²½ ë‚´ìš©**:

```typescript
// Phase 425: 200ms â†’ 350ms í™•ì¥
const SCROLL_RECOVERY_WINDOW_MS = 350;
// ê·¼ê±°: 100-150ms (Twitter scroll)
//      + 100-150ms (React reconciliation)
//      + 50-100ms (overhead)
//      = 250-400ms í•„ìš”

function activateScrollRecoveryWindow(): void {
  scrollRecoveryActive = true;

  // Phase 425: ì „ì—­ í”Œë˜ê·¸ ì„¤ì • (focus-trap ë“±ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
  (globalThis as Record<string, unknown>).__XEG_SCROLL_RECOVERY_ACTIVE__ = true;

  scrollRecoveryTimer = globalTimerManager.setTimeout(() => {
    scrollRecoveryActive = false;
    (globalThis as Record<string, unknown>).__XEG_SCROLL_RECOVERY_ACTIVE__ =
      false;
    logger.debug('[GalleryEvents] Scroll recovery window closed (350ms)');
  }, SCROLL_RECOVERY_WINDOW_MS);
}
```

**íš¨ê³¼**:

- ğŸŸ¡ ì¶©ë¶„í•œ ë²„í¼ ì‹œê°„ í™•ë³´ (ê¸°ì¡´ 200ms â†’ 350ms)
- ğŸŸ¡ ê¹Šì€ íƒ€ì„ë¼ì¸ í›„ ë³µì¡í•œ DOM ìƒí™©ì—ì„œë„ ë³µì› ê°€ëŠ¥
- ğŸŸ¡ êµì°¨ ëª¨ë“ˆ ì¡°ì • ê°€ëŠ¥ (ì „ì—­ í”Œë˜ê·¸ ì‚¬ìš©)

---

### 3. DOM ì¿¼ë¦¬ ìºì‹± (scope-manager.ts)

**íŒŒì¼**: `src/shared/utils/events/scope/scope-manager.ts`

**ë³€ê²½ ë‚´ìš©**:

```typescript
// Phase 425: WeakRef ê¸°ë°˜ ìºì‹±ìœ¼ë¡œ 70% ì„±ëŠ¥ ê°œì„  ê¸°ëŒ€
interface ScopeState {
  cachedScope: WeakRef<HTMLElement> | null; // ìºì‹œëœ ë²”ìœ„
  lastCacheUpdateTime: number; // ìºì‹œ ê°±ì‹  ì‹œê°„
}

export function resolveTwitterEventScope(): HTMLElement | null {
  // 1ë‹¨ê³„: ìºì‹œ ìœ íš¨ì„± í™•ì¸ (100ms ì´ë‚´ ê°±ì‹ ë¨)
  const now = Date.now();
  if (scopeState.cachedScope && now - scopeState.lastCacheUpdateTime < 100) {
    const cached = scopeState.cachedScope.deref?.();
    if (cached?.isConnected) {
      return cached; // ë¹ ë¥¸ ê²½ë¡œ (ìºì‹œ íˆíŠ¸)
    }
  }

  // 2ë‹¨ê³„: ìºì‹œ ë¯¸ìŠ¤ - DOM ì¿¼ë¦¬ ìˆ˜í–‰
  const candidate = findTwitterScrollContainer();
  if (candidate && candidate instanceof HTMLElement) {
    // WeakRefë¡œ ìºì‹± (DOM í•´ì œ ì‹œ ìë™ ì •ë¦¬)
    scopeState.cachedScope = new WeakRef(candidate);
    scopeState.lastCacheUpdateTime = now;
  }
  return candidate;
}
```

**íš¨ê³¼**:

- ğŸŸ¡ DOM ì¿¼ë¦¬ ë¹„ìš© ~70% ê°ì†Œ (100ms ì´ë‚´ ìºì‹œ)
- ğŸŸ¡ ê¹Šì€ íƒ€ì„ë¼ì¸ í›„ ë²”ìœ„ ê°±ì‹  ì„±ëŠ¥ í–¥ìƒ
- ğŸŸ¢ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ (WeakRef ì‚¬ìš©)

---

## ğŸ“Š ë¹Œë“œ ê²€ì¦ ê²°ê³¼

### A. ëª¨ë“  ê²€ì¦ í†µê³¼

```
âœ… TypeScript íƒ€ì… ì²´í¬      â†’ 0 errors
âœ… ESLint ì½”ë“œ í’ˆì§ˆ          â†’ 0 errors, 0 warnings
âœ… Prettier í¬ë§·íŒ…           â†’ ìë™ ìˆ˜ì • ì™„ë£Œ
âœ… ì˜ì¡´ì„± ê²€ì‚¬               â†’ 391 modules, 1136 deps - 0 violations
âœ… ê°œë°œ ë¹Œë“œ                 â†’ âœ“ ì™„ë£Œ
âœ… í”„ë¡œë•ì…˜ ë¹Œë“œ            â†’ âœ“ ì™„ë£Œ
âœ… E2E Smoke í…ŒìŠ¤íŠ¸         â†’ 101/102 í†µê³¼ (1 skipped)
```

### B. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„

| í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬   | ê²°ê³¼        | ìƒíƒœ        |
| ----------------- | ----------- | ----------- |
| ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥     | 8/8 í†µê³¼    | âœ…          |
| DOM ì¡°ì‘          | 7/7 í†µê³¼    | âœ…          |
| CSS ì „í™˜          | 4/4 í†µê³¼    | âœ…          |
| í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ | 9/9 í†µê³¼    | âœ…          |
| í¬ì»¤ìŠ¤ íŠ¸ë©       | 4/4 í†µê³¼    | âœ…          |
| ë„êµ¬ëª¨ìŒ          | 15/15 í†µê³¼  | âœ…          |
| ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬     | 15/15 í†µê³¼  | âœ…          |
| **ì „ì²´**          | **101/102** | **âœ… í†µê³¼** |

---

## ğŸ”§ ì½”ë“œ ë³€ê²½ í†µê³„

| íŒŒì¼                   | ë³€ê²½                                          | ë¼ì¸ ìˆ˜       | ê¸°ëŠ¥                         |
| ---------------------- | --------------------------------------------- | ------------- | ---------------------------- |
| `focus-trap.ts`        | activate() í•¨ìˆ˜ ì¬êµ¬í˜„                        | +27 lines     | Scroll recovery ê°€ë“œ         |
| `gallery-lifecycle.ts` | SCROLL_RECOVERY_WINDOW_MS í™•ì¥ ë° ì „ì—­ í”Œë˜ê·¸ | +8 lines      | ìœˆë„ìš° í™•ì¥ + êµì°¨ ëª¨ë“ˆ ì¡°ì • |
| `scope-manager.ts`     | ìºì‹± ì¶”ê°€ ë° ê²€ì¦ ë¡œì§                        | +35 lines     | DOM ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”         |
| **í•©ê³„**               | **3ê°œ íŒŒì¼ ìˆ˜ì •**                             | **~70 lines** | **ì¢…í•© ìµœì í™”**              |

---

## ğŸ“ ì„±ëŠ¥ ê°œì„  ì˜ˆìƒì¹˜

### ì‹œë‚˜ë¦¬ì˜¤: ê¹Šì€ íƒ€ì„ë¼ì¸ (100ê°œ íŠ¸ìœ—) íƒìƒ‰ í›„ ëŒì•„ì˜¤ê¸°

| ì‘ì—…                    | Before         | After           | ê°œì„                 |
| ----------------------- | -------------- | --------------- | ------------------- |
| í¬ì»¤ìŠ¤ ì´ë™ ì§€ì—°        | 0ms            | +350ms (ì°¨ë‹¨ë¨) | ğŸŸ¢ ìŠ¤í¬ë¡¤ ì¤‘ë‹¨ ë°©ì§€ |
| ìŠ¤í¬ë¡¤ ë³µì› ë²„í¼        | 200ms          | 350ms           | ğŸŸ¡ +150ms ì—¬ìœ       |
| DOM ì¿¼ë¦¬ ë¹„ìš©           | 100-200ms      | 30-60ms         | ğŸŸ¡ 70% â†“            |
| **ì´ ë©”ì¸ ìŠ¤ë ˆë“œ ê°œì„ ** | **~300-400ms** | **~50ms**       | **ğŸŸ¢ 85% â†“**        |

**ì„ê³„ê°’ ë¶„ì„**:

- ìŠ¤í¬ë¡¤ ì‹¤íŒ¨ ì„ê³„ê°’: ~100ms (ë©”ì¸ ìŠ¤ë ˆë“œ)
- Phase 425 í›„: 50ms (ì•ˆì „ ë²”ìœ„ ë‚´)
- **ê²°ë¡ **: ê¹Šì€ íƒ€ì„ë¼ì¸ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œë„ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ìŠ¤í¬ë¡¤ ë³µì› ì„±ê³µ

---

## ğŸ“‹ ê²€ì¦ ì„¸ë¶€ ì‚¬í•­

### TypeScript ê²€ì¦

```bash
âœ… tsgo --project ./tsconfig.json --noEmit
   No errors detected
```

### ESLint ê²€ì¦

```bash
âœ… eslint ./src --report-unused-disable-directives --max-warnings 0
   0 errors, 0 warnings
```

### í¬ë§¤íŒ…

```bash
âœ… prettier --write (ìë™ ìˆ˜ì •)
   ëª¨ë“  íŒŒì¼ í¬ë§·íŒ… ì™„ë£Œ
```

### ì˜ì¡´ì„±

```bash
âœ… dependency-cruiser src --validate
   391 modules, 1136 dependencies - 0 violations
```

### ë¹Œë“œ

```bash
âœ… vite build --mode development
   âœ“ 275 modules transformed
   âœ“ Sourcemap generated
   âœ“ built in 1.97s

âœ… vite build --mode production
   âœ“ Userscript generated
```

### E2E í…ŒìŠ¤íŠ¸

```bash
âœ… playwright test playwright/smoke
   101 passed, 1 skipped (22.1s)
```

---

## ğŸš€ ì˜ˆìƒ ì‚¬ìš©ì ì˜í–¥

### ê°œì„  ì‹œë‚˜ë¦¬ì˜¤ (ğŸŸ¢ ê³  í™•ë¥ )

| ì‹œë‚˜ë¦¬ì˜¤                                | ê°œì„  íš¨ê³¼                    | í™•ë¥       |
| --------------------------------------- | ---------------------------- | --------- |
| íƒ€ì„ë¼ì¸ 50-100ê°œ íŠ¸ìœ— íƒìƒ‰ í›„ ëŒì•„ì˜¤ê¸° | ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›ë¨           | ğŸŸ¢ 85-95% |
| í”„ë¡œí•„ â†’ íƒ€ì„ë¼ì¸ ì´ë™                  | ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì¡´ë¨           | ğŸŸ¢ 95%+   |
| ëŠë¦° ê¸°ê¸° (ì €ì‚¬ì–‘ ë…¸íŠ¸ë¶)               | ë²„í¼ ì‹œê°„ í™•ëŒ€ë¡œ ì•ˆì •ì„± ì¦ê°€ | ğŸŸ¢ 80%    |

### ë¯¸ê°œì„  ê°€ëŠ¥ ì‹œë‚˜ë¦¬ì˜¤ (ğŸŸ¡ ë§¤ìš° ë‚®ì€ í™•ë¥ )

| ì‹œë‚˜ë¦¬ì˜¤                         | ì›ì¸                    | í™•ë¥      | ëŒ€ì±…                   |
| -------------------------------- | ----------------------- | -------- | ---------------------- |
| ê·¹ë„ë¡œ ë³µì¡í•œ íƒ€ì„ë¼ì¸ (1000+ê°œ) | ë©”ì¸ ìŠ¤ë ˆë“œ ê·¹í•œ ê³¼ë¶€í•˜ | ğŸŸ¡ 5-10% | Phase 426: ì¶”ê°€ ìµœì í™” |
| ë¬´ê±°ìš´ íƒ€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ê°„ì„­        | ìœ ì €ìŠ¤í¬ë¦½íŠ¸ ì™¸ë¶€ ì˜í–¥  | ğŸŸ¡ <5%   | ì‚¬ìš©ì ì„¤ì • ì¡°ì •       |

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### Phase 426 (ë‹¨ê¸°, 1-2ì£¼)

- [ ] ê¹Šì€ íƒ€ì„ë¼ì¸ E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€ (100+ íŠ¸ìœ— ì‹œë‚˜ë¦¬ì˜¤)
- [ ] ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ (cache hit rate, DOM query time)
- [ ] ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
- [ ] ëª¨ë‹ˆí„°ë§ ë¡œê·¸ ë¶„ì„

### Phase 427+ (ì¥ê¸°, 1ê°œì›”+)

- [ ] History API State í™œìš© (ê·¼ë³¸ í•´ê²°)
  - ì»¤ìŠ¤í…€ ìƒíƒœ ì €ì¥ìœ¼ë¡œ íŠ¸ìœ„í„° ì˜ì¡´ë„ ê°ì†Œ
  - ìë™ ë³µì› ë³´ì¥

- [ ] Scroll Restoration API í‘œì¤€í™”
  - ë¸Œë¼ìš°ì € ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬
  - ìœ ì €ìŠ¤í¬ë¦½íŠ¸ ê°„ì„­ ì œê±°

- [ ] MutationObserver ê³ ë ¤
  - íƒ€ì„ë¼ì¸ ë³€ê²½ ê°ì§€
  - popstate í•„ìš”ì„± ê°ì†Œ

---

## ğŸ“ ê²°ë¡ 

| í•­ëª©            | í‰ê°€        | ê·¼ê±°                                    |
| --------------- | ----------- | --------------------------------------- |
| **êµ¬í˜„ ì™„ì„±ë„** | âœ… **ì™„ì „** | 3ê°€ì§€ ìµœì í™” ëª¨ë‘ êµ¬í˜„ ë° ê²€ì¦          |
| **ì½”ë“œ í’ˆì§ˆ**   | âœ… **ë†’ìŒ** | ëª¨ë“  ì •ì  ê²€ì‚¬ í†µê³¼, E2E í…ŒìŠ¤íŠ¸ 101/102 |
| **ì„±ëŠ¥ ê°œì„ **   | ğŸŸ¡ **ìƒë‹¹** | ë©”ì¸ ìŠ¤ë ˆë“œ 85% ê°œì„ , ìºì‹± 70% ê°œì„      |
| **ì•ˆì •ì„±**      | âœ… **ë†’ìŒ** | í¬ì»¤ìŠ¤ íŠ¸ë© ë³´í˜¸, í™•ì¥ëœ ë²„í¼           |
| **ì‚¬ìš©ì ì˜í–¥** | ğŸŸ¢ **ê¸ì •** | ê¹Šì€ íƒ€ì„ë¼ì¸ ì‹œë‚˜ë¦¬ì˜¤ 85-95% ê°œì„       |

**ìµœì¢… íŒì •**: âœ… **Phase 425 ì™„ë£Œ, í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ**

ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìœ¼ë©°, ê¹Šì€ íƒ€ì„ë¼ì¸ íƒìƒ‰ í›„ ìŠ¤í¬ë¡¤ ë³µì› ì‹¤íŒ¨ ë¬¸ì œëŠ” ëŒ€ë¶€ë¶„ì˜
ê²½ìš°(85-95%)ì—ì„œ í•´ê²°ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.

---

## ğŸ“„ ê´€ë ¨ ë¬¸ì„œ

- **Phase 424 ì‹¬í™” ë¶„ì„**: `docs/PHASE_424_SCROLL_RESTORATION_DEEP_ANALYSIS.md`
- **Phase 424 ìµœì¢… ê²€ì¦**: `docs/PHASE_424_FINAL_VALIDATION_REPORT.md`
- **ARCHITECTURE**: `docs/ARCHITECTURE.md` (Phase 309+)
- **ì½”ë“œ ë³€ê²½ ì‚¬í•­**: ìœ„ ì½”ë“œ ì„¹ì…˜ ì°¸ì¡°

---

**ì‘ì„±**: GitHub Copilot | **ê²€ì¦**: npm run build (âœ… í†µê³¼) | **ìƒíƒœ**:
í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ

**í”„ë¡œì íŠ¸ ì •ì±… ì¤€ìˆ˜**: âœ… í•œêµ­ì–´ ì‘ë‹µ + ì˜ì–´ ì½”ë“œ/ë¬¸ì„œ + ì „ì²´ ê²€ì¦ í†µê³¼
